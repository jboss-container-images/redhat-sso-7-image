schema_version: 1

name: "redhat-sso-cd-tech-preview/sso-cd-rhel8"
description: "Red Hat Single Sign-On Continuous Delivery container image, based on the Red Hat Universal Base Image 8 Minimal container image"
version: "7"
# KEYCLOAK-11405 Stick the base image down to "ubi8-minimal:8.0-213" (IMAGE ID == 8c980b20fbaa),
# so the Red Hat Single Sign-On Continuous Delivery container image contains fixes for both:
#
# * The RH BZ#1725863 microdnf bug, and also
# * The nghttp2 CVE fixes for CVE-2019-9511 and CVE-2019-9513 (RHSA-2019:2692)
#
from: "ubi8-minimal:8.0-213"
labels:
    - name: "com.redhat.component"
      value: "redhat-sso-cd-rhel8-container"
    - name: "org.jboss.product"
      value: "sso"
    - name: "org.jboss.product.version"
      value: "7"
    - name: "org.jboss.product.sso.version"
      value: "7"
envs:
    - name: "JBOSS_PRODUCT"
      value: "sso"
    - name: "JBOSS_SSO_VERSION"
      value: "7"
    - name: "PRODUCT_VERSION"
      value: "7"
packages:
      manager: microdnf
      content_sets:
            x86_64:
                - rhel-8-for-x86_64-baseos-rpms
                - rhel-8-for-x86_64-appstream-rpms
modules:
      repositories:
          - path: modules
          - name: cct_module
            git:
                url: https://github.com/jboss-openshift/cct_module.git
                ref: 0.35.1
          - name: jboss-eap-7-image
            git:
                url: https://github.com/jboss-container-images/jboss-eap-7-image.git
                ref: CD17_CR2
      install:
          - name: jboss.container.openjdk.jdk
            version: '11'
          - name: eap-cd-latest
          - name: sso
          - name: keycloak.openshift.clients
# artifacts:
      # Set by the pipeline. Consists of the server overlay zip, renamed to "keycloak-server-overlay.zip"
      # Use overrides/local-keycloak-zips-overrides.yaml to build the image using specific artifacts, stored locally
run:
      user: 185
      cmd:
          - "/opt/eap/bin/standalone.sh"
          - "-b"
          - "0.0.0.0"
          - "-c"
          - "standalone.xml"
osbs:
      configuration:
            container_file: container.yaml
      repository:
            name: containers/redhat-sso-7
            branch: jb-sso-cd-rhel8
